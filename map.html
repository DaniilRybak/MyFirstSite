<!doctype html>
<html lang="en">

<head>
    <head>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://api-maps.yandex.ru/2.1/?apikey=d1ebd746-8548-4cce-b6fb-31f1c129cba8&lang=ru_RU" type="text/javascript">
        </script>
        <script src="//code.jivo.ru/widget/UyyphSPhiW" async></script>
    </head>

    <title>ETB</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="css/styleMap.css">
    <link rel="icon" type="image/png" href="images for index.html/icon.png" >
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>

<body>
    <header class="page-header  page-header--blog">
        <div class="container">
            <div id="logo"> <!--Лого компании-->
                <a href="/"> <img src="images for index.html/logo.jpg" alt="Ошибка загрузки!" width="230px" height="60px"></a>
            </div>
            
            <button class="hamburger-button">
                <img src="images for index.html/listing.png" alt="Меню" width="45px" height="45px"> 
            </button>

            <div id="links"> <!--навигационные кнопки, обёрнутые в ссылки-->
                <a href="/"><button class="navigation" style="display: none;"></button></a>

                <a href="#information-project"><button class="navigation" id="OurInfo" style="display: none;">О нас</button></a>
                <a href="/map"><button class="navigation" id="mapButton">Карта</button></a>
                <a href="#contact-form"><button class="navigation" id="ObrCall" style="display: none;">Обратная связь</button></a>
                <a href="/"><button class="navigation" id="routesButton">Маршруты</button></a>
                <a href="#footer-teleport"><button class="navigation" id="Contact-info" style="display: none;">Контакты</button></a>
                <a href="/login"><button class="navigation" id="SignInAdmin1">Логин</button></a>
            </div>
            <div id="userpanel"> <!--фото пользователя и кнопка "домой"-->
                <div> 
                    <a href="/login"><img src="images for index.html/user_avatar.png" alt="" width="70px" height="70px"></a>
                </div>
            </div>
        </div>
    </header>
    <main>
        <div id="map" style="width: 100vw; height: 100vh"></div>
        <div id="bin-info" class="bin-info">
            <canvas id="fullnessChart" width="100" height="100"></canvas>
            <canvas id="chargeChart" width="100" height="100"></canvas>
            <!-- Информация о баке будет отображаться здесь -->
        </div>

        <div id="route-alert">
            <h2>Внимание!</h2>
            <p id="alert-message"></p> <div id="low-charge-alert" style="display: none;"> 
            <p>Обнаружены датчики с низким зарядом батареи.</p>
            <button onclick="closeLowChargeAlert()">Закрыть</button>
        </div> 
            <button onclick="closeRouteAlert()">Продолжить</button>
        </div>


        <script type="text/javascript">

            var options = {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0,
            };

            function success(pos) {
            var crd = pos.coords;

            console.log("Ваше текущее местоположение:");
            console.log(`Широта: ${crd.latitude}`);
            console.log(`Долгота: ${crd.longitude}`);
            console.log(`Плюс-минус ${crd.accuracy} метров.`);
            }

            function error(err) {
            console.warn(`ERROR(${err.code}): ${err.message}`);
            }

            navigator.geolocation.getCurrentPosition(success, error, options)


            function createChart(canvasId, percent) {
                var ctx = document.getElementById(canvasId).getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                    datasets: [{
                    data: [percent, 100 - percent], // Данные для диаграммы
                    backgroundColor: ['#4CAF50', '#f44336'] // Цвета сегментов
                    }]
                },
                options: {
                    cutoutPercentage: 70, // Размер отверстия в центре
                    responsive: false, // Отключаем адаптивность
                    legend: {
                        display: false // Скрываем легенду
                    },
                    tooltips: {
                        enabled: false // Отключаем всплывающие подсказки
                    }
                }
                });
            }

            function showRouteAlert(message = '') {
                document.getElementById('alert-message').innerText = message;
                document.getElementById('route-alert').style.display = 'block';
            }

            function closeRouteAlert() {
                document.getElementById('route-alert').style.display = 'none';
            }

            let myMap;  // Объявляем myMap здесь, чтобы она была доступна в других функциях
            let clusterer; // Объявляем clusterer здесь, чтобы он был доступен в других функциях
            let mapInitialized = false; 
            let placemarkColors = [
                '#4CAF50', // Зеленый
                '#f44336', // Красный
                '#FFA500' // Оранжевый
            ];

            function init() {
                
                myMap = new ymaps.Map("map", {
                    center: [47.214758, 38.914220], // Ваши координаты
                    zoom: 14 // Начальный зум
                }, {
                    searchControlProvider: 'yandex#search' // Добавляем поиск на карту
                });

                clusterer = new ymaps.Clusterer({
                    clusterIconLayout: 'default#pieChart',
                    clusterIconPieChartRadius: 25,
                    clusterIconPieChartCoreRadius: 10,
                    clusterIconPieChartStrokeWidth: 3,
                    hasBalloon: false
                });

                updateMapData(); // Первоначальная загрузка данных

                // Обновляем данные каждые 10 секунд (10000 миллисекунд)
                setInterval(updateMapData, 10000); 

                // Обработчик клика на карту (для скрытия подсказки)
                myMap.events.add('click', function () {
                    closeBinInfo(); 
                });
            }

            ymaps.ready(init);

            function updateMapData() {
                fetch('/api/bins')
                    .then(response => response.json())
                    .then(data => {
                    let fullBinsCount = 0;
                    let lowChargeCount = 0;
                    let geoObjects = [];

                    // Очищаем карту от старых объектов
                    myMap.geoObjects.remove(clusterer);
                    clusterer.removeAll(); 

                    // Обработка каждого мусорного бака
                    data.forEach(bin => {
                        let iconColor;

                        // Определение цвета маркера
                        if (bin.chargeLevel < 20) {
                        iconColor = placemarkColors[2]; // Оранжевый, если низкий заряд
                        lowChargeCount++;
                        } else {
                        iconColor = bin.fullness > 80 ? placemarkColors[1] : placemarkColors[0]; // Красный/Зеленый
                        }

                        // Подсчет заполненных баков
                        if (bin.fullness > 80) {
                        fullBinsCount++;
                        }

                        // Создание маркера
                        var marker = new ymaps.Placemark([bin.latitude, bin.longitude], {}, {
                        iconColor: iconColor
                        });

                        // Обработчик клика на маркер
                        marker.events.add('click', function () {
                        document.getElementById('bin-info').style.display = 'block';
                        document.getElementById('bin-info').innerHTML = `
                            <h2>Контейнер номер: ${bin.serial_number}</h2>
                            <div style="display: flex; gap: 40px;">
                            <div style="margin-right: 20px;">
                                <canvas id="fullnessChart" width="100" height="100"></canvas>
                                <p>Наполненность: ${bin.fullness}%</p>
                                ${bin.fullness > 80 ? '<p style="color: red;">Контейнер заполнен!</p>' : ''} 
                            </div>
                            <div>
                                <canvas id="chargeChart" width="100" height="100"></canvas>
                                <p>Заряд: ${bin.chargeLevel}%</p>
                                ${bin.chargeLevel < 20 ? '<p style="color: orange;">Требуется зарядка датчика!</p>' : ''} 
                            </div>
                            </div>
                            <button onclick="closeBinInfo()">Закрыть</button>
                        `;
                        createChart('fullnessChart', 100 - bin.fullness);
                        createChart('chargeChart', bin.chargeLevel);
                        });

                        // Добавление маркера в кластер
                        geoObjects.push(marker);
                        clusterer.add(marker);
                    });

                    // Логика для показа уведомлений
                    if (fullBinsCount >= 10 && lowChargeCount > 0) {
                        showRouteAlert(`Достаточное количество контейнеров заполнены. Необходимо выехать на маршрут для сбора мусора.\n\nНужна зарядка батарей в ${lowChargeCount} датчиках.`);
                    } else if (fullBinsCount >= 10) {
                        showRouteAlert('Достаточное количество контейнеров заполнены. Необходимо выехать на маршрут для сбора мусора.');
                    } else if (lowChargeCount > 0) {
                        showRouteAlert(`Необходимо зарядка батареи в ${lowChargeCount} датчиках.`);
                    }

                    // Добавляем кластер на карту
                    myMap.geoObjects.add(clusterer);

                    // Установка границ карты (только один раз)
                    if (!mapInitialized) {
                        myMap.setBounds(clusterer.getBounds(), { checkZoomRange: true });
                        mapInitialized = true; 
                    }
                    })
                    .catch(error => console.error('Ошибка при получении данных:', error));
                }

            function closeBinInfo() {
                document.getElementById('bin-info').style.display = 'none';
            }


            window.addEventListener('resize', function() {
            if (window.innerWidth < 768) { // Замените 768 на желаемую ширину
                window.scrollTo(0, 0);
            }
            });


            // Обработчик клика на кнопку "гамбургера"
            const hamburgerButton = document.querySelector('.hamburger-button');
            const links = document.getElementById('links'); // получаем элемент #links

            hamburgerButton.addEventListener('click', () => {
            links.classList.toggle('show'); // переключаем класс 'show' у #links
            });
        </script>
        <script src="scripts/Geolocathion.js" defer></script>

    </main>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>

</body>

</html>